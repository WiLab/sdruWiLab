
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Family Radio Service (FRS) Full-Duplex Transceiver with USRP&reg; Hardware</title><meta name="generator" content="MATLAB 8.2"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2013-04-19"><meta name="DC.source" content="sdruFRSFullDuplexTransceiver.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, tt, code { font-size:12px; }
pre { margin:0px 0px 20px; }
pre.error { color:red; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><style>
.open_example { 
    padding:0px 0px 1px 0px;
    margin:20px;
    font-size:0.9em;
    border:1px solid #aeaeae;
    display:block;
    float:right;
    border-radius:5px; -moz-border-radius:5px; -webkit-border-radius:5px;
    background: #ffffff; /* Old browsers */
    background: -moz-linear-gradient(top, #FFFFFF 0%, #E6E6E6 100%); /* FF3.6+ */	
    background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#FFFFFF), color-stop(100%,#E6E6E6)); /* Chrome,Safari4+ */
    background: -webkit-linear-gradient(top, #FFFFFF 0%,#E6E6E6 100%); /* Chrome10+,Safari5.1+ */
    background: -o-linear-gradient(top,  #ffffff 0%,#e6e6e6 100%); /* Opera 11.10+ */
    background: -ms-linear-gradient(top,  #ffffff 0%,#e6e6e6 100%); /* IE10+ */
    background: linear-gradient(top,  #ffffff 0%,#e6e6e6 100%); /* W3C */
    filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#FFFFFF', endColorstr='#E6E6E6',GradientType=0 ); /* IE6-9 */
}

.open_example:hover {
    background: #f3f3f3; /* Old browsers */
    background: -moz-linear-gradient(top, #f3f3f3 0%, #d7d7d7 100%); /* FF3.6+ */    
    background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#f3f3f3), color-stop(100%,#d7d7d7)); /* Chrome,Safari4+ */
    background: -webkit-linear-gradient(top, #f3f3f3 0%,#d7d7d7 100%); /* Chrome10+,Safari5.1+ */
    background: -o-linear-gradient(top,  #f3f3f3 0%,#d7d7d7 100%); /* Opera 11.10+ */
    background: -ms-linear-gradient(top,  #f3f3f3 0%,#d7d7d7 100%); /* IE10+ */
    background: linear-gradient(top,  #f3f3f3 0%,#d7d7d7 100%); /* W3C */
    filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#f3f3f3', endColorstr='#d7d7d7',GradientType=0 ); /* IE6-9 */
} 

.open_example a { 
    padding:6px 10px; 
    line-height:130%;
    text-decoration:none;
    float:left;
}
      </style><div class="open_example"><a href="matlab:edit sdruFRSFullDuplexTransceiver">Open this Example</a></div><div class="content"><h1>Family Radio Service (FRS) Full-Duplex Transceiver with USRP&reg; Hardware</h1><!--introduction--><p>This example shows how to use two Universal Software Radio Peripheral&reg; devices exploiting SDRu (Software Defined Radio USRP&reg;) System objects to perform full duplex communication by transmitting/receiving recorded audio simultaneously using MATLAB&reg; and the FRS protocol.  For a more detailed description of FRS processing, see <a href="matlab:edit('sdruFRSGMRSTransmitter.m')">sdruFRSGMRSTransmitter</a> and <a href="matlab:edit('sdruFRSGMRSReceiver.m')">sdruFRSGMRSReceiver</a>.</p><p>In order to run this example, you need two host computers connected to two USRP&reg; radios with daughterboards (e.g. SBX or WBX) that support full-duplex operation and the FRS band. Using this script, <a href="matlab:edit('sdruFRSFullDuplexTransceiver.m')">sdruFRSFullDuplexTransceiver</a>, the first USRP&reg; radio sends one audio signal at 467.6125 MHz, and simultaneously receives another audio signal at 467.6625 MHz.  The second USRP&reg; radio sends at 467.6625 MHz and receives at 467.6125 MHz using the MATLAB script <a href="matlab:edit('sdruFRSFullDuplexTransceiver_2.m')">sdruFRSFullDuplexTransceiver_2</a>.  Each host computer plays the received audio signal on its audio device.</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Initialization</a></li><li><a href="#2">Transmit One Audio File Using FRS Waveform</a></li><li><a href="#3">Receive Another Audio File Using FRS Demodulation</a></li><li><a href="#4">Stream Processing Loop</a></li><li><a href="#5">Conclusion</a></li><li><a href="#6">Appendix</a></li><li><a href="#7">Copyright Notice</a></li></ul></div><h2>Initialization<a name="1"></a></h2><p>The <a href="matlab:edit('configureFDTx.m')">configureFDTx</a> and <a href="matlab:edit('configureFDRx.m')">configureFDRx</a> MATLAB scripts initialize simulation parameters and generate parameter structures for the FRS transmitter and receiver systems.</p><p>The frequency calibration compensation value, rfRxFreqCorrection, can be determined for your USRP&reg; environment by running the MATLAB script <a href="matlab:edit('sdruFrequencyCalibrationReceiver.m')">sdruFrequencyCalibrationReceiver</a> while sending a sine wave at the RF receiver center frequency, rfRxFreq, with MATLAB script <a href="matlab:edit('sdruFrequencyCalibrationTransmitter.m')">sdruFrequencyCalibrationTransmitter</a>.</p><pre class="codeinput"><span class="comment">% Transmitter Initialization</span>
rfTxFreq           = 467.6125e6; <span class="comment">% RF Transmitter Center Frequency (Hz)</span>
paramsTx           = configureFDTx(rfTxFreq);

<span class="comment">% Receiver Initialization</span>
rfRxFreq           = 467.6625e6; <span class="comment">% RF Receiver Center Frequency (Hz)</span>
rfRxFreqCorrection = -4e3; <span class="comment">% Frequency calibration compensation value (Hz)</span>
rfRxFreqActual     = rfRxFreq + rfRxFreqCorrection;
paramsRx           = configureFDRx(rfRxFreqActual);
</pre><h2>Transmit One Audio File Using FRS Waveform<a name="2"></a></h2><p>This example uses a source object to generate data signals for the transmitter. The source signal is a multimedia audio file. When using a multimedia file, the sampling rate needs to be converted to 8 kHz; therefore, the FRSGMRSDemoAudioSource object employs a rate conversion filter to convert the 22.5 kHz signal to an 8 kHz signal.</p><pre class="codeinput"><span class="comment">% Create a data source to transmit the contents of a sound file at a</span>
<span class="comment">% sampling frequency of 8 kHz.</span>
hSource = FRSGMRSDemoSource(<span class="string">'Sound file'</span>, paramsTx.SampleRate);
hSource.AudioFileName = <span class="string">'speech_dft.avi'</span>;

<span class="comment">% The Continuous Tone-Coded Squelch System (CTCSS) filters out</span>
<span class="comment">% undesired communication or interference from these other users by</span>
<span class="comment">% generating a tone between 67 Hz and 250 Hz and transmitting it along with</span>
<span class="comment">% the source signal.</span>
hCTCSS = dsp.SineWave(paramsTx.CTCSSAmplitude, <span class="keyword">...</span>
                      paramsTx.ToneFrequencies(paramsTx.CTCSSCode), <span class="keyword">...</span>
                      <span class="string">'SampleRate'</span>,       paramsTx.SampleRate, <span class="keyword">...</span>
                      <span class="string">'SamplesPerFrame'</span>,  paramsTx.SourceFrameLength, <span class="keyword">...</span>
                      <span class="string">'OutputDataType'</span>,   <span class="string">'single'</span>);

<span class="comment">% The interpolator and FM modulator convert the sampling rate of the sum of</span>
<span class="comment">% the modulating signal and the CTCSS tone to match the USRP(R) hardware</span>
<span class="comment">% sampling rate of 200 kHz.</span>
hInterpolator = dsp.FIRInterpolator(paramsTx.InterpolationFactor, <span class="keyword">...</span>
                                    paramsTx.Numerator);

hIntegrator = dsp.DigitalFilter(<span class="string">'Structure'</span>,    <span class="string">'Direct form I'</span>, <span class="keyword">...</span>
                                <span class="string">'Numerator'</span>,    1, <span class="keyword">...</span>
                                <span class="string">'Denominator'</span>,  [1 -1]);

<span class="comment">% The SDRu transmitter sets the interpolation factor to 500 so that the</span>
<span class="comment">% example uses round numbers to convert the sampling rate from 8 kHz to 200</span>
<span class="comment">% kHz. The IP address of the System object must match that of the connected</span>
<span class="comment">% USRP(R) radio.</span>
hSDRuTx = comm.SDRuTransmitter(<span class="keyword">...</span>
               <span class="string">'IPAddress'</span>,              <span class="string">'192.168.10.2'</span>, <span class="keyword">...</span>
               <span class="string">'CenterFrequency'</span>,        paramsTx.CenterFrequency,<span class="keyword">...</span>
               <span class="string">'Gain'</span>,                   paramsTx.USRPGain, <span class="keyword">...</span>
               <span class="string">'InterpolationFactor'</span>,    paramsTx.USRPInterpolationFactor)
</pre><pre class="codeoutput">
hSDRuTx = 

  System: comm.SDRuTransmitter 

  Properties:
                      IPAddress: '192.168.10.2'  
          CenterFrequencySource: 'Property'      
                CenterFrequency: 467612500       
          ActualCenterFrequency: 467612500.001707
    LocalOscillatorOffsetSource: 'Property'      
          LocalOscillatorOffset: 0               
    ActualLocalOscillatorOffset: 2609.89181697369
                     GainSource: 'Property'      
                           Gain: 15              
                     ActualGain: 15              
      InterpolationFactorSource: 'Property'      
            InterpolationFactor: 500             
      ActualInterpolationFactor: 500             
             UnderrunOutputPort: false           
                EnableBurstMode: false           
                                                 
</pre><h2>Receive Another Audio File Using FRS Demodulation<a name="3"></a></h2><p>Create objects to resample the input to 200 kHz, perform automatic gain control, perform channel selectivity filtering, FM demodulate, resample to an 8 kHz audio output, perform CTCSS decoding, filter out the CTCSS tones, then send the signal to an audio output device.</p><pre class="codeinput"><span class="comment">% SDRu Receiver</span>
hSDRuRx = comm.SDRuReceiver(<span class="keyword">...</span>
    <span class="string">'IPAddress'</span>,             <span class="string">'192.168.10.2'</span>, <span class="keyword">...</span>
    <span class="string">'CenterFrequency'</span>,       paramsRx.CenterFrequency,<span class="keyword">...</span>
    <span class="string">'Gain'</span>,                  paramsRx.USRPGain, <span class="keyword">...</span>
    <span class="string">'DecimationFactor'</span>,      paramsRx.USRPDecimationFactor, <span class="keyword">...</span>
    <span class="string">'SampleRate'</span>,            paramsRx.FrontEndSampleRate, <span class="keyword">...</span>
    <span class="string">'FrameLength'</span>,           paramsRx.USRPFrameLength, <span class="keyword">...</span>
    <span class="string">'OutputDataType'</span>,        <span class="string">'single'</span>)

<span class="comment">% AGC</span>
hAGC = comm.AGC(<span class="string">'UpdatePeriod'</span>, 200, <span class="keyword">...</span>
                <span class="string">'StepSize'</span>,     0.1);

<span class="comment">% Low pass filter for channel separation</span>
hChanFilt = dsp.DigitalFilter(<span class="string">'TransferFunction'</span>, <span class="string">'FIR (all zeros)'</span>, <span class="keyword">...</span>
                              <span class="string">'Numerator'</span>, paramsRx.ChannelFilterNumerator);

<span class="comment">% FM demodulator using phase difference of consecutive complex samples</span>
hDelay = dsp.Delay;

<span class="comment">% Decimation filter to resample to 8 kHz</span>
hDecimator = dsp.FIRDecimator(paramsRx.DecimationFactor, paramsRx.Numerator);

<span class="comment">% The CTCSS decoder compares the estimated received code with the</span>
<span class="comment">% preselected code and then sends the signal to the audio device if the two</span>
<span class="comment">% codes match.</span>
hDecoder = FRSGMRSDemoCTCSSDecoder(<span class="keyword">...</span>
          <span class="string">'MinimumBlockLength'</span>, paramsRx.CTCSSDecodeBlockLength, <span class="keyword">...</span>
          <span class="string">'SampleRate'</span>,         paramsRx.SampleRate);

<span class="comment">% High pass filter to filter out CTCSS tones</span>
hAudioFilt = dsp.DigitalFilter(<span class="string">'TransferFunction'</span>, <span class="string">'FIR (all zeros)'</span>, <span class="keyword">...</span>
                               <span class="string">'Numerator'</span>, paramsRx.AudioFilterNumerator);

<span class="comment">% Audio player</span>
hAudio = dsp.AudioPlayer(paramsRx.SampleRate);
</pre><pre class="codeoutput">
hSDRuRx = 

  System: comm.SDRuReceiver 

  Properties:
                      IPAddress: '192.168.10.2'   
          CenterFrequencySource: 'Property'       
                CenterFrequency: 467658500        
          ActualCenterFrequency: 467658500.005457 
    LocalOscillatorOffsetSource: 'Property'       
          LocalOscillatorOffset: 0                
    ActualLocalOscillatorOffset: -2822.34977930784
                     GainSource: 'Property'       
                           Gain: 5                
                     ActualGain: 5                
         DecimationFactorSource: 'Property'       
               DecimationFactor: 500              
         ActualDecimationFactor: 500              
              OverrunOutputPort: false            
                     SampleRate: 200000           
                 OutputDataType: 'single'         
                    FrameLength: 4000             
                EnableBurstMode: false            
                                                  
</pre><h2>Stream Processing Loop<a name="4"></a></h2><pre class="codeinput"><span class="comment">% Perform stream processing if a radio is found.</span>
radio = findsdru(hSDRuRx.IPAddress);
<span class="keyword">if</span> (strcmp(radio.Status,<span class="string">'Success'</span>))
    <span class="comment">% Loop until the example reaches the target stop time.</span>
    timeCounter = 0;

    <span class="keyword">while</span> timeCounter &lt; paramsTx.StopTime
        <span class="comment">% Transmitter stream processing</span>
        <span class="comment">% -----------------------------------------------------------------</span>
        data_tx = step(hSource);  <span class="comment">% Generate audio waveform</span>
        dataWTone = data_tx + step(hCTCSS);  <span class="comment">% Add CTCSS tones</span>
        outResamp = step(hInterpolator, dataWTone);  <span class="comment">% Resample to 200 kHz</span>

        <span class="comment">% Create integrated phase for FM modulation</span>
        outInteg  = step(hIntegrator, outResamp);
        <span class="comment">% FM modulation</span>
        outMod    = exp(1i*paramsTx.FrequencySensitivityGain * outInteg);
        step(hSDRuTx, outMod); <span class="comment">% Transmit to USRP(R) radio</span>


        <span class="comment">% Receiver stream processing</span>
        <span class="comment">% -----------------------------------------------------------------</span>
        [data_rx, len_rx] = step(hSDRuRx);
        <span class="keyword">if</span> len_rx &gt; 0
            outAGC      = step(hAGC, data_rx); <span class="comment">% AGC</span>
            outChanFilt = step(hChanFilt, outAGC); <span class="comment">% Adjacent channel filtering</span>
            rxAmp       = mean(abs(outChanFilt));
            <span class="keyword">if</span> rxAmp &gt; paramsRx.DetectionThreshold
                outThreshold = outChanFilt;
            <span class="keyword">else</span>
                outThreshold = complex(single(zeros(paramsRx.USRPFrameLength, 1)));
            <span class="keyword">end</span>

            xDelay  = step(hDelay, outThreshold);
            outFMDemod  = angle(xDelay .* conj(outThreshold)); <span class="comment">% FM demodulate</span>
            outDecim  = step(hDecimator, outFMDemod); <span class="comment">% Resample to 8 kHz</span>

            <span class="comment">% CTCSS decode and conditionally send to audio output</span>
            rcvdCode = step(hDecoder, outDecim);
            <span class="keyword">if</span> (rcvdCode == paramsRx.CTCSSCode) || (paramsRx.CTCSSCode == 0)
                rcvdSig = outDecim;
            <span class="keyword">else</span>
                rcvdSig = single(zeros(paramsRx.AudioFrameLength, 1));
            <span class="keyword">end</span>

            audioSig = step(hAudioFilt, rcvdSig); <span class="comment">% Filter out CTCSS tones</span>
            step(hAudio, audioSig); <span class="comment">% Audio output</span>
            timeCounter = timeCounter + paramsRx.USRPFrameTime;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">else</span>
    warning(message(<span class="string">'sdru:sysobjdemos:MainLoop'</span>))
<span class="keyword">end</span>

<span class="comment">% Release all SDRu resources</span>
release(hSDRuTx); clear <span class="string">hSDRuTx</span>
release(hSDRuRx); clear <span class="string">hSDRuRx</span>
</pre><pre class="codeoutput"></pre><h2>Conclusion<a name="5"></a></h2><p>In this example, you used Communications System Toolbox&#8482; System objects to perform full duplex transmission and reception using FRS waveforms and two USRP&reg; radios.</p><h2>Appendix<a name="6"></a></h2><p>The following scripts are used in this example.</p><div><ul><li><a href="matlab:edit('configureFDTx.m')">configureFDTx.m</a></li><li><a href="matlab:edit('configureFDRx.m')">configureFDRx.m</a></li><li><a href="matlab:edit('sdruFRSFullDuplexTransceiver_2.m')">sdruFRSFullDuplexTransceiver_2.m</a></li></ul></div><h2>Copyright Notice<a name="7"></a></h2><p>Universal Software Radio Peripheral&reg; and USRP&reg; are trademarks of National Instruments Corp.</p><p class="footer">Copyright 2013 The MathWorks, Inc.<br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2013b</a><br><br>
		  MATLAB and Simulink are registered trademarks of The MathWorks, Inc.  Please see <a href="http://www.mathworks.com/trademarks">www.mathworks.com/trademarks</a> for a list of other trademarks owned by The MathWorks, Inc.  Other product or brand names are trademarks or registered trademarks of their respective owners.
      </p></div><!--
##### SOURCE BEGIN #####
%% Family Radio Service (FRS) Full-Duplex Transceiver with USRP(R) Hardware
% This example shows how to use two Universal Software Radio Peripheral(R)
% devices exploiting SDRu (Software Defined Radio USRP(R)) System objects to
% perform full duplex communication by transmitting/receiving recorded
% audio simultaneously using MATLAB(R) and the FRS protocol.  For a more
% detailed description of FRS processing, see
% <matlab:edit('sdruFRSGMRSTransmitter.m') sdruFRSGMRSTransmitter> and
% <matlab:edit('sdruFRSGMRSReceiver.m') sdruFRSGMRSReceiver>.
%
% In order to run this example, you need two host computers connected to
% two USRP(R) radios with daughterboards (e.g. SBX or WBX) that support
% full-duplex operation and the FRS band. Using this script,
% <matlab:edit('sdruFRSFullDuplexTransceiver.m')
% sdruFRSFullDuplexTransceiver>, the first USRP(R) radio sends one audio
% signal at 467.6125 MHz, and simultaneously receives another audio signal
% at 467.6625 MHz.  The second USRP(R) radio sends at 467.6625 MHz and
% receives at 467.6125 MHz using the MATLAB script
% <matlab:edit('sdruFRSFullDuplexTransceiver_2.m')
% sdruFRSFullDuplexTransceiver_2>.  Each host computer plays the received
% audio signal on its audio device.
%
%   Copyright 2013 The MathWorks, Inc.

%% Initialization
% The <matlab:edit('configureFDTx.m') configureFDTx> and
% <matlab:edit('configureFDRx.m') configureFDRx> MATLAB scripts initialize
% simulation parameters and generate parameter structures for the FRS
% transmitter and receiver systems.
%
% The frequency calibration compensation value, rfRxFreqCorrection, can be
% determined for your USRP(R) environment by running the MATLAB script
% <matlab:edit('sdruFrequencyCalibrationReceiver.m')
% sdruFrequencyCalibrationReceiver> while sending a sine wave at the RF
% receiver center frequency, rfRxFreq, with MATLAB script
% <matlab:edit('sdruFrequencyCalibrationTransmitter.m')
% sdruFrequencyCalibrationTransmitter>.

% Transmitter Initialization
rfTxFreq           = 467.6125e6; % RF Transmitter Center Frequency (Hz)
paramsTx           = configureFDTx(rfTxFreq);

% Receiver Initialization
rfRxFreq           = 467.6625e6; % RF Receiver Center Frequency (Hz)
rfRxFreqCorrection = -4e3; % Frequency calibration compensation value (Hz)
rfRxFreqActual     = rfRxFreq + rfRxFreqCorrection;
paramsRx           = configureFDRx(rfRxFreqActual);

%% Transmit One Audio File Using FRS Waveform
%
% This example uses a source object to generate data signals for the
% transmitter. The source signal is a multimedia audio file. When using a
% multimedia file, the sampling rate needs to be converted to 8 kHz;
% therefore, the FRSGMRSDemoAudioSource object employs a rate conversion
% filter to convert the 22.5 kHz signal to an 8 kHz signal.

% Create a data source to transmit the contents of a sound file at a
% sampling frequency of 8 kHz.
hSource = FRSGMRSDemoSource('Sound file', paramsTx.SampleRate);
hSource.AudioFileName = 'speech_dft.avi';

% The Continuous Tone-Coded Squelch System (CTCSS) filters out
% undesired communication or interference from these other users by
% generating a tone between 67 Hz and 250 Hz and transmitting it along with
% the source signal.
hCTCSS = dsp.SineWave(paramsTx.CTCSSAmplitude, ...
                      paramsTx.ToneFrequencies(paramsTx.CTCSSCode), ...
                      'SampleRate',       paramsTx.SampleRate, ...
                      'SamplesPerFrame',  paramsTx.SourceFrameLength, ...
                      'OutputDataType',   'single');
                  
% The interpolator and FM modulator convert the sampling rate of the sum of
% the modulating signal and the CTCSS tone to match the USRP(R) hardware
% sampling rate of 200 kHz.
hInterpolator = dsp.FIRInterpolator(paramsTx.InterpolationFactor, ...
                                    paramsTx.Numerator);
                                
hIntegrator = dsp.DigitalFilter('Structure',    'Direct form I', ...
                                'Numerator',    1, ...
                                'Denominator',  [1 -1]);

% The SDRu transmitter sets the interpolation factor to 500 so that the
% example uses round numbers to convert the sampling rate from 8 kHz to 200
% kHz. The IP address of the System object must match that of the connected
% USRP(R) radio.
hSDRuTx = comm.SDRuTransmitter(...
               'IPAddress',              '192.168.10.2', ...
               'CenterFrequency',        paramsTx.CenterFrequency,...
               'Gain',                   paramsTx.USRPGain, ...
               'InterpolationFactor',    paramsTx.USRPInterpolationFactor)

%% Receive Another Audio File Using FRS Demodulation 
%
% Create objects to resample the input to 200 kHz, perform automatic gain
% control, perform channel selectivity filtering, FM demodulate, resample
% to an 8 kHz audio output, perform CTCSS decoding, filter out the CTCSS
% tones, then send the signal to an audio output device.

% SDRu Receiver
hSDRuRx = comm.SDRuReceiver(...
    'IPAddress',             '192.168.10.2', ...
    'CenterFrequency',       paramsRx.CenterFrequency,...
    'Gain',                  paramsRx.USRPGain, ...
    'DecimationFactor',      paramsRx.USRPDecimationFactor, ...
    'SampleRate',            paramsRx.FrontEndSampleRate, ...
    'FrameLength',           paramsRx.USRPFrameLength, ...
    'OutputDataType',        'single')

% AGC
hAGC = comm.AGC('UpdatePeriod', 200, ...
                'StepSize',     0.1);

% Low pass filter for channel separation
hChanFilt = dsp.DigitalFilter('TransferFunction', 'FIR (all zeros)', ...
                              'Numerator', paramsRx.ChannelFilterNumerator);

% FM demodulator using phase difference of consecutive complex samples
hDelay = dsp.Delay;

% Decimation filter to resample to 8 kHz
hDecimator = dsp.FIRDecimator(paramsRx.DecimationFactor, paramsRx.Numerator);

% The CTCSS decoder compares the estimated received code with the
% preselected code and then sends the signal to the audio device if the two
% codes match.
hDecoder = FRSGMRSDemoCTCSSDecoder(...
          'MinimumBlockLength', paramsRx.CTCSSDecodeBlockLength, ...
          'SampleRate',         paramsRx.SampleRate);

% High pass filter to filter out CTCSS tones
hAudioFilt = dsp.DigitalFilter('TransferFunction', 'FIR (all zeros)', ...
                               'Numerator', paramsRx.AudioFilterNumerator);

% Audio player
hAudio = dsp.AudioPlayer(paramsRx.SampleRate);

%% Stream Processing Loop

% Perform stream processing if a radio is found.
radio = findsdru(hSDRuRx.IPAddress);
if (strcmp(radio.Status,'Success'))
    % Loop until the example reaches the target stop time.
    timeCounter = 0;
    
    while timeCounter < paramsTx.StopTime
        % Transmitter stream processing
        % REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
        data_tx = step(hSource);  % Generate audio waveform 
        dataWTone = data_tx + step(hCTCSS);  % Add CTCSS tones
        outResamp = step(hInterpolator, dataWTone);  % Resample to 200 kHz

        % Create integrated phase for FM modulation
        outInteg  = step(hIntegrator, outResamp); 
        % FM modulation
        outMod    = exp(1i*paramsTx.FrequencySensitivityGain * outInteg);
        step(hSDRuTx, outMod); % Transmit to USRP(R) radio
        
        
        % Receiver stream processing
        % REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
        [data_rx, len_rx] = step(hSDRuRx);
        if len_rx > 0
            outAGC      = step(hAGC, data_rx); % AGC
            outChanFilt = step(hChanFilt, outAGC); % Adjacent channel filtering
            rxAmp       = mean(abs(outChanFilt));
            if rxAmp > paramsRx.DetectionThreshold
                outThreshold = outChanFilt;
            else
                outThreshold = complex(single(zeros(paramsRx.USRPFrameLength, 1)));
            end
                     
            xDelay  = step(hDelay, outThreshold);
            outFMDemod  = angle(xDelay .* conj(outThreshold)); % FM demodulate
            outDecim  = step(hDecimator, outFMDemod); % Resample to 8 kHz
            
            % CTCSS decode and conditionally send to audio output
            rcvdCode = step(hDecoder, outDecim); 
            if (rcvdCode == paramsRx.CTCSSCode) || (paramsRx.CTCSSCode == 0)
                rcvdSig = outDecim;
            else
                rcvdSig = single(zeros(paramsRx.AudioFrameLength, 1));
            end
            
            audioSig = step(hAudioFilt, rcvdSig); % Filter out CTCSS tones
            step(hAudio, audioSig); % Audio output 
            timeCounter = timeCounter + paramsRx.USRPFrameTime;
        end
    end
else
    warning(message('sdru:sysobjdemos:MainLoop'))
end

% Release all SDRu resources
release(hSDRuTx); clear hSDRuTx
release(hSDRuRx); clear hSDRuRx

%% Conclusion
% In this example, you used Communications System Toolbox(TM) System objects
% to perform full duplex transmission and reception using FRS waveforms and
% two USRP(R) radios.
%
%
%% Appendix
% The following scripts are used in this example.
%
% * <matlab:edit('configureFDTx.m') configureFDTx.m>
% * <matlab:edit('configureFDRx.m') configureFDRx.m>
% * <matlab:edit('sdruFRSFullDuplexTransceiver_2.m')
% sdruFRSFullDuplexTransceiver_2.m>
%
%% Copyright Notice
% Universal Software Radio Peripheral(R) and USRP(R) are trademarks of
% National Instruments Corp.
displayEndOfDemoMessage(mfilename)
##### SOURCE END #####
--></body></html>