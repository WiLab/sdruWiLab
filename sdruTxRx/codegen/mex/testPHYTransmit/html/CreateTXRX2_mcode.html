<pre class="code">
<span class="srcline"><span class="lineno"><a href="2,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1173U3">ObjAGC</span>,<span class="var type1" id="S3T1227U4">ObjSDRuReceiver</span>, <span class="var type1" id="S4T830U5">ObjSDRuTransmitter</span>, <span class="var type1" id="S5T1317U6">ObjDetect</span>, <span class="var type1" id="S6T1102U7">ObjPreambleDemod</span>, <span class="var type1" id="S7T1103U8">ObjDataDemod</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,2" id="srcline2"> 2</a></span><span class="line">          <span class="var type1" id="S8T1106U9">estimate</span>, <span class="var type1" id="S9T770U10">tx</span>, <span class="var type1" id="S10T1U11">timeoutDuration</span>, <span class="var type1" id="S11T766U12">messageBits</span>, <span class="var type0" id="S12T0U13">desiredSamplingFrequency</span>] = CreateTXRX</span></span>
<span class="srcline"><span class="lineno"><a href="2,3" id="srcline3"> 3</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,4" id="srcline4"> 4</a></span><span class="line"><span class="comment">% System parameters to adjust because of hardware limitation</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,5" id="srcline5"> 5</a></span><span class="line"><span class="mxinfo" id="T1:U11"><span class="var type1" id="S13T1U18">numFrames</span> = <span class="mxinfo" id="T1:U13">1</span></span>; <span class="comment">% Frames to capture</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,6" id="srcline6"> 6</a></span><span class="line"><span class="mxinfo" id="T1:U14"><span class="var type1" id="S12T1U22">desiredSamplingFrequency</span> =  <span class="mxinfo" id="T1:U16">5e6</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,7" id="srcline7"> 7</a></span><span class="line"><span class="mxinfo" id="T1:U17"><span class="var type1" id="S14T1U26">USRPADCSamplingRate</span> = <span class="mxinfo" id="T1:U19">100e6</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,8" id="srcline8"> 8</a></span><span class="line"><span class="mxinfo" id="T1:U20"><span class="var type1" id="S15T1U30">InterpolationFactor</span> = <span class="mxinfo" id="T1:U22"><span class="var type1" id="S14T1U32">USRPADCSamplingRate</span>/<span class="var type1" id="S12T1U33">desiredSamplingFrequency</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,9" id="srcline9"> 9</a></span><span class="line"><span class="mxinfo" id="T1:U25"><span class="var type1" id="S16T1U36">CenterFrequency</span> = <span class="mxinfo" id="T1:U27">2.24e9</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,10" id="srcline10">10</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,11" id="srcline11">11</a></span><span class="line"><span class="mxinfo" id="T768:U28">[ <span class="mxinfo" id="T1:U29">~</span>, <span class="mxinfo" id="T1:U30">~</span>, <span class="mxinfo" id="T1:U31"><span class="mxinfo" id="T1:U32">~</span></span>, <span class="var type1" id="S9T770U44">tx</span> ] = <span class="fcn" id="F9N65:B46">generateOFDMSignal_TX2</span>( <span class="string">'UnimportantMessage'</span>, <span class="var type1" id="S12T1U48">desiredSamplingFrequency</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,12" id="srcline12">12</a></span><span class="line"><span class="mxinfo" id="T1:U35"><span class="mxinfo" id="T1:U36"><span class="var type1" id="S9T770U52">tx</span>.samplingFreq</span> = <span class="var type1" id="S12T1U54">desiredSamplingFrequency</span></span>;<span class="comment">% Set desired frequeny</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,13" id="srcline13">13</a></span><span class="line"><span class="mxinfo" id="T1:U39"><span class="mxinfo" id="T1:U40"><span class="var type1" id="S9T770U58">tx</span>.CenterFrequency</span> = <span class="var type1" id="S16T1U60">CenterFrequency</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,14" id="srcline14">14</a></span><span class="line"><span class="mxinfo" id="T1:U43"><span class="mxinfo" id="T1:U44"><span class="var type1" id="S9T770U64">tx</span>.freqBin</span> = <span class="mxinfo" id="T1:U46"><span class="mxinfo" id="T1:U47"><span class="var type1" id="S9T770U68">tx</span>.samplingFreq</span>/<span class="mxinfo" id="T1:U49"><span class="var type1" id="S9T770U71">tx</span>.FFTLength</span></span></span>;<span class="comment">% Set frequency bin width</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,15" id="srcline15">15</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,16" id="srcline16">16</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,17" id="srcline17">17</a></span><span class="line"><span class="comment">% Setup transmitter</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,18" id="srcline18">18</a></span><span class="line"><span class="mxinfo" id="T830:U51"><span class="var type1" id="S4T830U75">ObjSDRuTransmitter</span> = <span class="mxinfo" id="T830:U53">comm.<span class="fcn" id="F1500N45:B79">SDRuTransmitter</span>(<span class="string">'192.168.10.2'</span>, <span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="2,19" id="srcline19">19</a></span><span class="line"><span class="mxinfo" id="T830:U51"><span class="mxinfo" id="T830:U53">    <span class="string">'CenterFrequency'</span>,      <span class="var type1" id="S16T1U82">CenterFrequency</span>, <span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="2,20" id="srcline20">20</a></span><span class="line"><span class="mxinfo" id="T830:U51"><span class="mxinfo" id="T830:U53">    <span class="string">'InterpolationFactor'</span>,  <span class="var type1" id="S15T1U84">InterpolationFactor</span>,<span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="2,21" id="srcline21">21</a></span><span class="line"><span class="mxinfo" id="T830:U51"><span class="mxinfo" id="T830:U53">    <span class="string">'Gain'</span>,                 25)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,22" id="srcline22">22</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,23" id="srcline23">23</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,24" id="srcline24">24</a></span><span class="line"><span class="comment">% Setup Parameters</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,25" id="srcline25">25</a></span><span class="line"><span class="mxinfo" id="T1102:U56">[ <span class="var type1" id="S6T1102U90">ObjPreambleDemod</span>, <span class="var type1" id="S7T1103U91">ObjDataDemod</span>, <span class="mxinfo" id="T1:U59"><span class="mxinfo" id="T1:U60">~</span></span>, <span class="var type1" id="S19T767U93">rx</span> ] = <span class="fcn" id="F1620N64:B95">generateOFDMSignal</span>(<span class="var type1" id="S12T1U96">desiredSamplingFrequency</span>)</span>;<span class="comment">%_TX2('HelloShannon');</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,26" id="srcline26">26</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,27" id="srcline27">27</a></span><span class="line"><span class="mxinfo" id="T1:U63"><span class="mxinfo" id="T1:U64"><span class="var type1" id="S19T767U100">rx</span>.receiveBufferLength</span> = <span class="mxinfo" id="T1:U66">5120</span></span>;<span class="comment">%ceil( rx.frameLength*4 ); %Size of Buffer of sliding window</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,28" id="srcline28">28</a></span><span class="line"><span class="mxinfo" id="T1:U67"><span class="var type1" id="S21T1U105">receiveBufferLength</span> = <span class="mxinfo" id="T1:U69">5120</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,29" id="srcline29">29</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,30" id="srcline30">30</a></span><span class="line"><span class="mxinfo" id="T1:U70"><span class="mxinfo" id="T1:U71"><span class="var type1" id="S19T767U110">rx</span>.DecimationFactor</span> = <span class="mxinfo" id="T1:U73"><span class="mxinfo" id="T1:U74"><span class="var type1" id="S14T1U113">USRPADCSamplingRate</span></span>/<span class="mxinfo" id="T1:U76"><span class="var type1" id="S19T767U115">rx</span>.samplingFreq</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,31" id="srcline31">31</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,32" id="srcline32">32</a></span><span class="line"><span class="mxinfo" id="T1:U78"><span class="var type1" id="S22T1U119">offsetCompensationValue</span> = <span class="mxinfo" id="T1:U80">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,33" id="srcline33">33</a></span><span class="line"><span class="comment">%offsetCompensationValue = -77148;% Get from calibration</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,34" id="srcline34">34</a></span><span class="line"><span class="comment">%offsetCompensationValue = 71289;% Get from calibration</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,35" id="srcline35">35</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,36" id="srcline36">36</a></span><span class="line"><span class="comment">% Sync Algorithms</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,37" id="srcline37">37</a></span><span class="line"><span class="mxinfo" id="T1:U81"><span class="var type1" id="S23T1U123">numFreqToAverage</span> = <span class="mxinfo" id="T1:U83">15</span></span>; <span class="comment">%Number of frequency estimates to be averaged together for frequency corrections (Higher==More stability, Lower==More responsiveness)</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,38" id="srcline38">38</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,39" id="srcline39">39</a></span><span class="line"><span class="comment">%Create memory structure to collect measurements for sync algorithms</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,40" id="srcline40">40</a></span><span class="line"><span class="mxinfo" id="T1106:U84">[<span class="var type1" id="S8T1106U128">estimate</span>, <span class="mxinfo" id="T1:U86"><span class="mxinfo" id="T1:U87">~</span></span>] = <span class="fcn" id="F2093N68:B131">initializeOFDMSyncMemory_sdr</span>( <span class="mxinfo" id="T1:U88"><span class="var type1" id="S19T767U133">rx</span>.receiveBufferLength</span>, <span class="var type1" id="S23T1U135">numFreqToAverage</span>, <span class="var type1" id="S19T767U136">rx</span>, <span class="mxinfo" id="T2:U92">false</span>, <span class="var type1" id="S6T1102U139">ObjPreambleDemod</span>, <span class="var type1" id="S7T1103U140">ObjDataDemod</span> )</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,41" id="srcline41">41</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,42" id="srcline42">42</a></span><span class="line"><span class="comment">% Gain control</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,43" id="srcline43">43</a></span><span class="line"><span class="mxinfo" id="T1173:U95"><span class="var type1" id="S2T1173U143">ObjAGC</span> = <span class="mxinfo" id="T1173:U97">comm.AGC(<span class="string">'UpdatePeriod'</span>, <span class="var type1" id="S21T1U149">receiveBufferLength</span>)</span></span>; <span class="comment">% Value must be constant, equal to rx.receiveBufferLength</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,44" id="srcline44">44</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,45" id="srcline45">45</a></span><span class="line"><span class="comment">% USRP</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,46" id="srcline46">46</a></span><span class="line"><span class="mxinfo" id="T1227:U99"><span class="var type1" id="S3T1227U152">ObjSDRuReceiver</span> = <span class="mxinfo" id="T1227:U101">comm.<span class="fcn" id="F2164N43:B156">SDRuReceiver</span>( <span class="string">'192.168.10.2'</span>, <span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="2,47" id="srcline47">47</a></span><span class="line"><span class="mxinfo" id="T1227:U99"><span class="mxinfo" id="T1227:U101">    <span class="string">'CenterFrequency'</span>,      <span class="var type1" id="S16T1U160">CenterFrequency</span> + <span class="var type1" id="S22T1U161">offsetCompensationValue</span>, <span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="2,48" id="srcline48">48</a></span><span class="line"><span class="mxinfo" id="T1227:U99"><span class="mxinfo" id="T1227:U101">    <span class="string">'DecimationFactor'</span>,     <span class="mxinfo" id="T1:U104"><span class="var type1" id="S19T767U164">rx</span>.DecimationFactor</span>,<span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="2,49" id="srcline49">49</a></span><span class="line"><span class="mxinfo" id="T1227:U99"><span class="mxinfo" id="T1227:U101">    <span class="string">'FrameLength'</span>,          <span class="var type1" id="S21T1U167">receiveBufferLength</span>,<span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="2,50" id="srcline50">50</a></span><span class="line"><span class="mxinfo" id="T1227:U99"><span class="mxinfo" id="T1227:U101">    <span class="string">'OutputDataType'</span>,       <span class="string">'double'</span>,<span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="2,51" id="srcline51">51</a></span><span class="line"><span class="mxinfo" id="T1227:U99"><span class="mxinfo" id="T1227:U101">    <span class="string">'Gain'</span>,                 18)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,52" id="srcline52">52</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,53" id="srcline53">53</a></span><span class="line"><span class="comment">% CRC</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,54" id="srcline54">54</a></span><span class="line"><span class="mxinfo" id="T1317:U107"><span class="var type1" id="S5T1317U174">ObjDetect</span> = <span class="mxinfo" id="T1317:U109">comm.CRCDetector([1 0 0 1], <span class="string">'ChecksumsPerFrame'</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,55" id="srcline55">55</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,56" id="srcline56">56</a></span><span class="line"><span class="comment">% Timeout info</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,57" id="srcline57">57</a></span><span class="line"><span class="mxinfo" id="T1:U110"><span class="var type1" id="S26T1U189">buffersPerSecond</span> = <span class="mxinfo" id="T1:U112">(<span class="mxinfo" id="T1:U113"><span class="mxinfo" id="T1:U114">100e6</span>/<span class="mxinfo" id="T1:U115"><span class="var type1" id="S19T767U195">rx</span>.DecimationFactor</span></span>)/<span class="mxinfo" id="T1:U117"><span class="var type1" id="S19T767U198">rx</span>.receiveBufferLength</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,58" id="srcline58">58</a></span><span class="line"><span class="mxinfo" id="T1:U119"><span class="var type1" id="S10T1U202">timeoutDuration</span> = <span class="mxinfo" id="T1:U121">floor(<span class="mxinfo" id="T1:U122"><span class="var type1" id="S26T1U206">buffersPerSecond</span>*<span class="mxinfo" id="T1:U124">0.05</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="2,59" id="srcline59">59</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,60" id="srcline60">60</a></span><span class="line"><span class="comment">% Soft decisions</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,61" id="srcline61">61</a></span><span class="line"><span class="mxinfo" id="T766:U125"><span class="var type1" id="S11T766U210">messageBits</span> = <span class="mxinfo" id="T766:U127">zeros(<span class="mxinfo" id="T1:U128"><span class="var type1" id="S13T1U213">numFrames</span></span>,<span class="mxinfo" id="T1:U130"><span class="mxinfo" id="T1:U131"><span class="mxinfo" id="T1:U132"><span class="var type1" id="S19T767U217">rx</span>.messageCharacters</span>*<span class="mxinfo" id="T1:U134">7</span></span>+<span class="mxinfo" id="T1:U135">3</span></span>)</span></span>;<span class="comment">%3 for CRC</span></span></span>
<span class="srcline"><span class="lineno"><a href="2,62" id="srcline62">62</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,63" id="srcline63">63</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="2,64" id="srcline64">64</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
