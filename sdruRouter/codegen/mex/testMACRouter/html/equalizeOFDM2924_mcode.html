<pre class="code">
<span class="srcline"><span class="lineno"><a href="173,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T536U3">R</span>, <span class="var type1" id="S3T1519U4">Rraw</span>, <span class="var type1" id="S4T1105U5">estimate</span>] = equalizeOFDM( <span class="var type1" id="S5T1108U8">recv</span>, <span class="var type1" id="S6T1323U9">tx</span>, <span class="mxinfo" id="T1105:U6"><span class="mxinfo" id="T1105:U7"><span class="var type1" id="S4T1105U10">estimate</span></span></span>, <span class="var type1" id="S7T1478U11">hPreambleDemod</span>, <span class="var type1" id="S8T1520U12">hDataDemod</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="173,2" id="srcline2"> 2</a></span><span class="line">    <span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,3" id="srcline3"> 3</a></span><span class="line">    <span class="comment">% equalizeOFDM: Equalize the entire OFDM frame through the use of both</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,4" id="srcline4"> 4</a></span><span class="line">    <span class="comment">% the long preamble from the 802.11a standard and four pilot tones in</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,5" id="srcline5"> 5</a></span><span class="line">    <span class="comment">% the data frames themselves.  The gains from the pilots are</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,6" id="srcline6"> 6</a></span><span class="line">    <span class="comment">% interpolated across frequency to fill the data frame and apply gains</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,7" id="srcline7"> 7</a></span><span class="line">    <span class="comment">% to all data subcarriers.</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,8" id="srcline8"> 8</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="173,9" id="srcline9"> 9</a></span><span class="line">    <span class="comment">%% Use Long Preamble frame to estimate channel in frequency domain</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,10" id="srcline10">10</a></span><span class="line">    <span class="comment">% Separate out received preambles</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,11" id="srcline11">11</a></span><span class="line">    <span class="mxinfo" id="T700:U11"><span class="var type1" id="S9T700U15">rLong</span> = <span class="mxinfo" id="T700:U13"><span class="var type1" id="S5T1108U17">recv</span>(<span class="mxinfo" id="T2493:U15"><span class="mxinfo" id="T1:U16">length(<span class="var type1" id="S6T1323U23">tx</span>.completeShortPreambleOFDM)+1</span> : <span class="mxinfo" id="T1:U18">length(<span class="var type1" id="S6T1323U30">tx</span>.completeShortPreambleOFDM)+length(<span class="var type1" id="S6T1323U35">tx</span>.completeLongPreambleOFDM)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="173,12" id="srcline12">12</a></span><span class="line">    <span class="mxinfo" id="T197:U21"><span class="var type1" id="S11T197U39">rLongFirst</span> = <span class="mxinfo" id="T197:U23"><span class="var type1" id="S9T700U41">rLong</span>(<span class="mxinfo" id="T2494:U25"><span class="mxinfo" id="T1:U26">33</span>:<span class="mxinfo" id="T1:U27">32+length(<span class="var type1" id="S6T1323U49">tx</span>.longPreambleOFDM)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="173,13" id="srcline13">13</a></span><span class="line">    <span class="mxinfo" id="T197:U29"><span class="var type1" id="S12T197U53">rLongSecond</span> = <span class="mxinfo" id="T197:U31"><span class="var type1" id="S9T700U55">rLong</span>(<span class="mxinfo" id="T2494:U33"><span class="mxinfo" id="T1:U34">33+length(<span class="var type1" id="S6T1323U62">tx</span>.longPreambleOFDM)</span> : <span class="mxinfo" id="T1:U36">32+length(<span class="var type1" id="S6T1323U70">tx</span>.longPreambleOFDM)*2</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="173,14" id="srcline14">14</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="173,15" id="srcline15">15</a></span><span class="line">    <span class="comment">% Demod</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,16" id="srcline16">16</a></span><span class="line">    <span class="mxinfo" id="T1519:U38"><span class="var type1" id="S13T1519U75">RLongFirst</span> = <span class="mxinfo" id="T1519:U40">step(<span class="var type1" id="S7T1478U78">hPreambleDemod</span>, <span class="var type1" id="S11T197U79">rLongFirst</span>)</span></span>; <span class="comment">%First half of long preamble</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,17" id="srcline17">17</a></span><span class="line">    <span class="mxinfo" id="T1519:U43"><span class="var type1" id="S15T1519U82">RLongSecond</span> = <span class="mxinfo" id="T1519:U45">step(<span class="var type1" id="S7T1478U85">hPreambleDemod</span>, <span class="var type1" id="S12T197U86">rLongSecond</span>)</span></span>; <span class="comment">%Second half of long preamble</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,18" id="srcline18">18</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="173,19" id="srcline19">19</a></span><span class="line">    <span class="comment">%% Preamble Equalization</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,20" id="srcline20">20</a></span><span class="line">    <span class="comment">% Get Equalizer tap gains</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,21" id="srcline21">21</a></span><span class="line">    <span class="mxinfo" id="T119:U48"><span class="var type1" id="S16T119U89">preambleEqGains</span> = <span class="mxinfo" id="T119:U50"><span class="fcn" id="F3051N108:B91">preambleFDE</span>(<span class="mxinfo" id="T1519:U51">[<span class="var type1" id="S13T1519U94">RLongFirst</span>, <span class="var type1" id="S15T1519U95">RLongSecond</span>]</span>, <span class="mxinfo" id="T1523:U54">[<span class="mxinfo" id="T209:U55"><span class="var type1" id="S6T1323U99">tx</span>.longPreamble</span>, <span class="mxinfo" id="T209:U57"><span class="var type1" id="S6T1323U102">tx</span>.longPreamble</span>]</span>, <span class="var type1" id="S8T1520U104">hDataDemod</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="173,22" id="srcline22">22</a></span><span class="line">      </span></span>
<span class="srcline"><span class="lineno"><a href="173,23" id="srcline23">23</a></span><span class="line">    <span class="comment">% Separate data from preambles</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,24" id="srcline24">24</a></span><span class="line">    <span class="comment">%recvData = recv(length(tx.preambles)+1:length(tx.preambles)+(hDataDemod.NumSymbols)*(tx.FFTLength+hDataDemod.CyclicPrefixLength));</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,25" id="srcline25">25</a></span><span class="line">    <span class="mxinfo" id="T699:U60"><span class="var type1" id="S18T699U107">recvData</span> = <span class="mxinfo" id="T699:U62"><span class="var type1" id="S5T1108U109">recv</span>(<span class="mxinfo" id="T2495:U64"><span class="mxinfo" id="T1:U65">320+1</span>:<span class="mxinfo" id="T1:U66">1280</span></span>)</span></span>; <span class="comment">% CG</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,26" id="srcline26">26</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="173,27" id="srcline27">27</a></span><span class="line">    <span class="comment">% OFDM Demod</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,28" id="srcline28">28</a></span><span class="line">    <span class="mxinfo" id="T1519:U67">[<span class="var type1" id="S3T1519U118">Rraw</span>, <span class="var type1" id="S19T1571U119">RXPilots</span>] = step(<span class="var type1" id="S8T1520U122">hDataDemod</span>, <span class="var type1" id="S18T699U123">recvData</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="173,29" id="srcline29">29</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="173,30" id="srcline30">30</a></span><span class="line">    <span class="comment">% Expand equalizer gains to full frame size</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,31" id="srcline31">31</a></span><span class="line">    <span class="mxinfo" id="T1572:U72"><span class="var type1" id="S20T1572U126">preambleGainsFull</span> = <span class="mxinfo" id="T1572:U74">repmat(<span class="var type1" id="S16T119U129">preambleEqGains</span> ,1 , <span class="var type1" id="S8T1520U132">hDataDemod</span>.NumSymbols)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="173,32" id="srcline32">32</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="173,33" id="srcline33">33</a></span><span class="line">    <span class="comment">% Isolate pilot gains from preamble equalizer</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,34" id="srcline34">34</a></span><span class="line">    <span class="mxinfo" id="T1571:U77"><span class="var type1" id="S22T1571U136">preamblePilotGains</span> = <span class="mxinfo" id="T1571:U79"><span class="var type1" id="S20T1572U138">preambleGainsFull</span>(<span class="mxinfo" id="T154:U81"><span class="var type1" id="S6T1323U140">tx</span>.pilotLocationsWithoutGuardbands</span>,:)</span></span>; <span class="comment">% Needed to correctly adjust pilot gains</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,35" id="srcline35">35</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="173,36" id="srcline36">36</a></span><span class="line">    <span class="comment">% Apply preamble equalizer gains to data and pilots</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,37" id="srcline37">37</a></span><span class="line">    <span class="mxinfo" id="T1571:U83"><span class="var type1" id="S19T1571U145">RXPilots</span> = <span class="mxinfo" id="T1571:U85"><span class="var type1" id="S22T1571U147">preamblePilotGains</span>.*<span class="var type1" id="S19T1571U148">RXPilots</span></span></span>; <span class="comment">%Correct pilots</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,38" id="srcline38">38</a></span><span class="line">    <span class="mxinfo" id="T1107:U88"><span class="var type1" id="S2T1107U151">R</span> = <span class="mxinfo" id="T1107:U90"><span class="mxinfo" id="T1107:U91"><span class="var type1" id="S20T1572U154">preambleGainsFull</span>(<span class="mxinfo" id="T764:U93"><span class="var type1" id="S6T1323U156">tx</span>.dataSubcarrierIndexies</span>,:)</span>.*<span class="var type1" id="S3T1519U159">Rraw</span></span></span>;<span class="comment">%Correct data</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,39" id="srcline39">39</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="173,40" id="srcline40">40</a></span><span class="line">    <span class="comment">%% Pilot Equalization</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,41" id="srcline41">41</a></span><span class="line">    <span class="comment">% Get pilot-based equalizer gains</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,42" id="srcline42">42</a></span><span class="line">    <span class="mxinfo" id="T536:U96"><span class="var type1" id="S23T536U162">pilotEqGains</span> = <span class="mxinfo" id="T536:U98"><span class="fcn" id="F3230N107:B164">pilotFDE</span>(<span class="var type1" id="S19T1571U165">RXPilots</span>, <span class="mxinfo" id="T539:U100"><span class="var type1" id="S6T1323U167">tx</span>.pilots</span>, 12)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="173,43" id="srcline43">43</a></span><span class="line">       </span></span>
<span class="srcline"><span class="lineno"><a href="173,44" id="srcline44">44</a></span><span class="line">    <span class="comment">% Apply Equalizer from Pilots</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,45" id="srcline45">45</a></span><span class="line">    <span class="mxinfo" id="T536:U102"><span class="var type1" id="S2T536U172">R</span> = <span class="mxinfo" id="T536:U104"><span class="var type1" id="S23T536U174">pilotEqGains</span>.*<span class="var type1" id="S2T1107U175">R</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="173,46" id="srcline46">46</a></span><span class="line">       </span></span>
<span class="srcline"><span class="lineno"><a href="173,47" id="srcline47">47</a></span><span class="line">    <span class="comment">% Save Gains for visualization</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,48" id="srcline48">48</a></span><span class="line">    <span class="mxinfo" id="T1107:U107"><span class="mxinfo" id="T1107:U108"><span class="var type1" id="S4T1105U179">estimate</span>.pilotEqGains</span> = <span class="var type1" id="S23T536U181">pilotEqGains</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="173,49" id="srcline49">49</a></span><span class="line">    <span class="mxinfo" id="T1108:U111"><span class="mxinfo" id="T1108:U112"><span class="var type1" id="S4T1105U185">estimate</span>.preambleEqGains</span> = <span class="var type1" id="S16T119U187">preambleEqGains</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="173,50" id="srcline50">50</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="173,51" id="srcline51">51</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="173,52" id="srcline52">52</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="173,53" id="srcline53">53</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="173,54" id="srcline54">54</a></span><span class="line"><span class="comment">% Calculate Equalizer Taps with preamble symbols</span></span></span>
</pre>
