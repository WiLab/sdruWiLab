<pre class="code">
<span class="srcline"><span class="lineno"><a href="152,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">preambleEstimatedLocation</span>, <span class="var type1" id="S3T1U4">numPeaks</span> ] = locateOFDMFrame_sdr( <span class="var type1" id="S4T1U7">FFTLength</span>, <span class="var type1" id="S5T197U8">shortPreambleOFDM</span>, <span class="var type1" id="S6T1399U9">recv</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="152,2" id="srcline2"> 2</a></span><span class="line"><span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="152,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">% locateOFDMFrame: Locate 802.11a based preamble from input data stream.</span></span></span>
<span class="srcline"><span class="lineno"><a href="152,4" id="srcline4"> 4</a></span><span class="line"><span class="comment">% It is assumed that the received signal is still in the time domain.  The</span></span></span>
<span class="srcline"><span class="lineno"><a href="152,5" id="srcline5"> 5</a></span><span class="line"><span class="comment">% location of the start of the preamble will be returned, if not found -1</span></span></span>
<span class="srcline"><span class="lineno"><a href="152,6" id="srcline6"> 6</a></span><span class="line"><span class="comment">% is returned</span></span></span>
<span class="srcline"><span class="lineno"><a href="152,7" id="srcline7"> 7</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="152,8" id="srcline8"> 8</a></span><span class="line"><span class="comment">%% Timing Estimate</span></span></span>
<span class="srcline"><span class="lineno"><a href="152,9" id="srcline9"> 9</a></span><span class="line"><span class="mxinfo" id="T1:U6"><span class="var type1" id="S7T1U12">windowLength</span> = <span class="mxinfo" id="T1:U8">ceil(length(<span class="var type1" id="S6T1399U18">recv</span>)/4)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="152,10" id="srcline10">10</a></span><span class="line"><span class="mxinfo" id="T1:U10"><span class="var type1" id="S10T1U22">L</span> = <span class="var type1" id="S4T1U23">FFTLength</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="152,11" id="srcline11">11</a></span><span class="line"><span class="mxinfo" id="T1:U13"><span class="var type1" id="S11T1U26">K</span> = <span class="mxinfo" id="T1:U15"><span class="var type1" id="S4T1U28">FFTLength</span>/<span class="mxinfo" id="T1:U17">4</span></span></span>; <span class="comment">% Quarter of short preamble sequence</span></span></span>
<span class="srcline"><span class="lineno"><a href="152,12" id="srcline12">12</a></span><span class="line"><span class="mxinfo" id="T1108:U18"><span class="var type1" id="S12T1108U32">known</span> = <span class="mxinfo" id="T1108:U20"><span class="var type1" id="S5T197U34">shortPreambleOFDM</span>(<span class="mxinfo" id="T1:U22">1</span>:<span class="var type1" id="S11T1U37">K</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="152,13" id="srcline13">13</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="152,14" id="srcline14">14</a></span><span class="line"><span class="comment">% Cross correlate</span></span></span>
<span class="srcline"><span class="lineno"><a href="152,15" id="srcline15">15</a></span><span class="line"><span class="mxinfo" id="T1108:U24"><span class="var type1" id="S13T1108U40">rWin</span> = <span class="mxinfo" id="T1108:U26"><span class="var type1" id="S6T1399U42">recv</span>(<span class="mxinfo" id="T1:U28">1</span>:<span class="mxinfo" id="T1:U29"><span class="mxinfo" id="T1:U30"><span class="mxinfo" id="T1:U31"><span class="var type1" id="S7T1U48">windowLength</span>-<span class="var type1" id="S10T1U49">L</span></span>+<span class="var type1" id="S11T1U50">K</span></span>-<span class="mxinfo" id="T1:U35">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="152,16" id="srcline16">16</a></span><span class="line"><span class="mxinfo" id="T1108:U36"><span class="var type1" id="S14T1108U54">Phat</span> = <span class="mxinfo" id="T1108:U38">xcorr(<span class="var type1" id="S13T1108U57">rWin</span>,<span class="mxinfo" id="T1108:U40">conj(<span class="var type1" id="S12T1108U60">known</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="152,17" id="srcline17">17</a></span><span class="line"><span class="mxinfo" id="T183:U42"><span class="var type1" id="S17T183U63">Rhat</span> = <span class="mxinfo" id="T183:U44">xcorr(<span class="mxinfo" id="T183:U45"><span class="mxinfo" id="T183:U46">abs(<span class="var type1" id="S13T1108U69">rWin</span>)</span>.^2</span>,<span class="mxinfo" id="T183:U48">ones(<span class="var type1" id="S11T1U73">K</span>,1)</span>)</span></span>; <span class="comment">% moving average</span></span></span>
<span class="srcline"><span class="lineno"><a href="152,18" id="srcline18">18</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="152,19" id="srcline19">19</a></span><span class="line"><span class="comment">% Remove leading and tail zeros overlaps</span></span></span>
<span class="srcline"><span class="lineno"><a href="152,20" id="srcline20">20</a></span><span class="line"><span class="mxinfo" id="T1108:U50"><span class="var type1" id="S20T1108U77">PhatShort</span> = <span class="mxinfo" id="T1108:U52"><span class="var type1" id="S14T1108U79">Phat</span>(<span class="mxinfo" id="T1:U54">ceil(<span class="mxinfo" id="T1:U55"><span class="mxinfo" id="T1:U56">length(<span class="var type1" id="S14T1108U86">Phat</span>)</span>/<span class="mxinfo" id="T1:U58">2</span></span>)</span>:<span class="mxinfo" id="T1:U59"><span class="mxinfo" id="T1:U60"><span class="mxinfo" id="T1:U61">end</span>-<span class="mxinfo" id="T1:U62"><span class="var type1" id="S11T1U93">K</span>/<span class="mxinfo" id="T1:U64">2</span></span></span>+<span class="mxinfo" id="T1:U65">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="152,21" id="srcline21">21</a></span><span class="line"><span class="mxinfo" id="T183:U66"><span class="var type1" id="S22T183U98">RhatShort</span> = <span class="mxinfo" id="T183:U68"><span class="var type1" id="S17T183U100">Rhat</span>(<span class="mxinfo" id="T1:U70">ceil(<span class="mxinfo" id="T1:U71"><span class="mxinfo" id="T1:U72">length(<span class="var type1" id="S17T183U107">Rhat</span>)</span>/<span class="mxinfo" id="T1:U74">2</span></span>)</span>:<span class="mxinfo" id="T1:U75"><span class="mxinfo" id="T1:U76"><span class="mxinfo" id="T1:U77">end</span>-<span class="mxinfo" id="T1:U78"><span class="var type1" id="S11T1U114">K</span>/<span class="mxinfo" id="T1:U80">2</span></span></span>+<span class="mxinfo" id="T1:U81">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="152,22" id="srcline22">22</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="152,23" id="srcline23">23</a></span><span class="line"><span class="comment">% Calculate timing metric</span></span></span>
<span class="srcline"><span class="lineno"><a href="152,24" id="srcline24">24</a></span><span class="line"><span class="mxinfo" id="T183:U82"><span class="var type1" id="S23T183U119">M</span> = <span class="mxinfo" id="T183:U84"><span class="mxinfo" id="T183:U85"><span class="mxinfo" id="T183:U86">abs(<span class="var type1" id="S20T1108U124">PhatShort</span>)</span>.^2</span> ./ <span class="mxinfo" id="T183:U88"><span class="var type1" id="S22T183U127">RhatShort</span>.^2</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="152,25" id="srcline25">25</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="152,26" id="srcline26">26</a></span><span class="line"><span class="comment">% Determine start of short preamble</span></span></span>
<span class="srcline"><span class="lineno"><a href="152,27" id="srcline27">27</a></span><span class="line"><span class="mxinfo" id="T1:U90"><span class="var type1" id="S24T1U131">threshold</span> = <span class="mxinfo" id="T1:U92">0.6</span></span>; <span class="comment">% peak threshold after normalization (TUNABLE)</span></span></span>
<span class="srcline"><span class="lineno"><a href="152,28" id="srcline28">28</a></span><span class="line"><span class="mxinfo" id="T1:U93">[<span class="var type1" id="S2T1U136">preambleEstimatedLocation</span>, <span class="var type1" id="S3T1U137">numPeaks</span>] = <span class="fcn" id="F2762N120:B139">locateShortpreamble</span>( <span class="var type1" id="S23T183U140">M</span>, <span class="var type1" id="S11T1U141">K</span>, <span class="var type1" id="S24T1U142">threshold</span> )</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="152,29" id="srcline29">29</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="152,30" id="srcline30">30</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="152,31" id="srcline31">31</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="152,32" id="srcline32">32</a></span><span class="line"></span></span>
</pre>
